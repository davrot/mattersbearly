services:
  postgres:
    image: postgres:18-alpine
    container_name: postgres
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    pids_limit: 100
    read_only: true
    tmpfs:
      - /tmp
      - /var/run/postgresql
    volumes:
      - ./postgresql/data:/var/lib/postgresql
    environment:
      TZ: CET
      POSTGRES_USER: mmuser
      POSTGRES_PASSWORD: REDACTED
      POSTGRES_DB: mattermost
    networks:
      - mattermost-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  mattermost:
    container_name: mattermost
    depends_on:
      postgres:
        condition: service_healthy

    image: mattermost-final:latest
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    pids_limit: 200
    read_only: false
    tmpfs:
      - /tmp
    volumes:
      - ./mattermost/config:/mattermost/config:rw
      - ./mattermost/data:/mattermost/data:rw
      - ./mattermost/logs:/mattermost/logs:rw
      - ./mattermost/plugins:/mattermost/plugins:rw
      - ./mattermost/client/plugins:/mattermost/client/plugins:rw
      - ./mattermost/bleve-indexes:/mattermost/bleve-indexes:rw
    environment:
      TZ: CET
      MM_SQLSETTINGS_DRIVERNAME: postgres
      MM_SQLSETTINGS_DATASOURCE: postgres://mmuser:REDACTEDg@postgres:5432/mattermost?sslmode=disable&connect_timeout=10

      MM_SERVICESETTINGS_SITEURL: https://mattermost.neuro.uni-bremen.de
      MM_BLEVESETTINGS_INDEXDIR: /mattermost/bleve-indexes

      MM_OIDCSETTINGS_ENABLE: true
      MM_OIDCSETTINGS_ID: mattermost
      MM_OIDCSETTINGS_SECRET: REDACTED
      MM_OIDCSETTINGS_SCOPE: "openid profile email"
      MM_OIDCSETTINGS_BUTTONTEXT: "Login with Uni Bremen SSO"
      MM_OIDCSETTINGS_UPDATEUSERDETAILSONLOGIN: true
      MM_OIDCSETTINGS_DISCOVERYENDPOINT: "https://sso.fb1.uni-bremen.de/sso/realms/master"

      MM_PLUGINSETTINGS_ENABLEUPLOADS: true

      MM_LOGSETTINGS_CONSOLELEVEL: DEBUG
      MM_LOGSETTINGS_FILELEVEL: DEBUG

    ports:
      - 8443:8443/udp
      - 8443:8443/tcp

    networks:
      - mattermost-network

    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8065/api/v4/system/ping || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  nginx:
    depends_on:
      mattermost:
        condition: service_healthy

    container_name: nginx
    image: nginx:alpine
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    pids_limit: 100
    read_only: true
    tmpfs:
      - /var/run
      - /var/cache
      - /var/log/nginx
    volumes:
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./nginx/dhparams4096.pem:/dhparams4096.pem
      - ./nginx/crt.pem:/cert.pem:ro
      - ./nginx/key.pem:/key.pem:ro
      - ./shared-webroot:/usr/share/nginx/html

    environment:
      TZ: CET

    ports:
      - 80:80
      - 443:443

    networks:
      - mattermost-network

    healthcheck:
      test: ["CMD-SHELL", "curl -fsI --connect-timeout 10 http://localhost || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

networks:
  mattermost-network:
    external: true

