--- ./tmp_original_source/server/channels/api4/oauth.go	2026-01-05 09:02:00.000000000 +0100
+++ ./changed_files/server/channels/api4/oauth.go	2026-01-16 20:51:51.345285375 +0100
@@ -6,6 +6,8 @@
 import (
 	"encoding/json"
 	"net/http"
+    "errors"
+    "fmt"
 
 	"github.com/mattermost/mattermost/server/public/model"
 	"github.com/mattermost/mattermost/server/public/shared/mlog"
@@ -24,6 +26,10 @@
 	api.BaseRoutes.OAuthApps.Handle("/register", api.RateLimitedHandler(api.APIHandler(registerOAuthClient), model.RateLimitSettings{PerSec: model.NewPointer(2), MaxBurst: model.NewPointer(1)})).Methods(http.MethodPost)
 
 	api.BaseRoutes.User.Handle("/oauth/apps/authorized", api.APISessionRequired(getAuthorizedOAuthApps)).Methods(http.MethodGet)
+
+    api.BaseRoutes.OAuth.Handle("/oidc/login", api.APIHandler(oidcLogin)).Methods("GET")
+    api.BaseRoutes.OAuth.Handle("/oidc/complete", api.APIHandler(completeOIDC)).Methods("GET", "POST")
+    api.BaseRoutes.OAuth.Handle("/oidc/metadata", api.APIHandler(getOIDCMetadata)).Methods("GET")
 }
 
 func createOAuthApp(c *Context, w http.ResponseWriter, r *http.Request) {
@@ -428,3 +434,98 @@
 		c.Logger.Warn("Error writing DCR response", mlog.Err(err))
 	}
 }
+
+// Fixed oidcLogin handler
+func oidcLogin(c *Context, w http.ResponseWriter, r *http.Request) {
+    if !*c.App.Config().OIDCSettings.Enable {
+        c.Err = model.NewAppError("oidcLogin", "api.oauth.oidc_login.disabled.app_error", nil, "", http.StatusNotImplemented)
+        return
+    }
+
+    state := model.NewId()
+    
+    // Store state in session for verification
+    c.App.SetOAuthState(state)
+    
+    authURL := c.App.GetOIDCAuthURL(state)
+    
+    if authURL == "" {
+        c.Err = model.NewAppError("oidcLogin", "api.oauth.oidc_login.config_error.app_error", nil, "OIDC provider not initialized", http.StatusInternalServerError)
+        return
+    }
+    
+    c.Logger.Debug("OIDC: Redirecting to auth URL", mlog.String("state", state))
+    http.Redirect(w, r, authURL, http.StatusFound)
+}
+
+// Fixed completeOIDC handler with correct logger syntax and DoLogin handling
+func completeOIDC(c *Context, w http.ResponseWriter, r *http.Request) {
+    code := r.URL.Query().Get("code")
+    state := r.URL.Query().Get("state")
+    
+    c.Logger.Debug("OIDC: Complete callback received", 
+        mlog.String("code_length", fmt.Sprintf("%d", len(code))),
+        mlog.String("state", state))
+    
+    if code == "" || state == "" {
+        c.Logger.Error("OIDC: Missing code or state parameter")
+        c.Err = model.NewAppError("completeOIDC", "api.oauth.missing_params.app_error", nil, "", http.StatusBadRequest)
+        http.Redirect(w, r, c.GetSiteURLHeader()+"/login?extra=oidc_missing_params", http.StatusFound)
+        return
+    }
+    
+    if !c.App.VerifyOAuthState(state) {
+        c.Logger.Error("OIDC: Invalid or expired state token")
+        c.Err = model.NewAppError("completeOIDC", "api.oauth.invalid_state.app_error", nil, "", http.StatusBadRequest)
+        http.Redirect(w, r, c.GetSiteURLHeader()+"/login?extra=oidc_invalid_state", http.StatusFound)
+        return
+    }
+    
+    user, err := c.App.CompleteOIDCLogin(c.AppContext, code, state)
+    if err != nil {
+        c.Logger.Error("OIDC: Failed to complete login", mlog.Err(err))
+        var appErr *model.AppError
+        if errors.As(err, &appErr) {
+            c.Err = appErr
+        } else {
+            c.Err = model.NewAppError("completeOIDC", "api.oauth.complete_oidc.app_error", nil, err.Error(), http.StatusInternalServerError)
+        }
+        http.Redirect(w, r, c.GetSiteURLHeader()+"/login?extra=oidc_error", http.StatusFound)
+        return
+    }
+    
+    c.Logger.Debug("OIDC: User authenticated", mlog.String("user_id", user.Id))
+    
+    // Use the standard DoLogin method which handles session creation
+    // DoLogin returns (*model.Session, error)
+    session, err2 := c.App.DoLogin(c.AppContext, w, r, user, "", false, false, false)
+    if err2 != nil {
+        c.Logger.Error("OIDC: Failed to create session", mlog.Err(err2))
+        c.Err = err2
+        http.Redirect(w, r, c.GetSiteURLHeader()+"/login?extra=session_error", http.StatusFound)
+        return
+    }
+    
+    // Attach session cookies
+    c.App.AttachSessionCookies(c.AppContext, w, r)
+    
+    c.Logger.Info("OIDC: Login completed successfully", 
+        mlog.String("user_id", user.Id),
+        mlog.String("session_id", session.Id))
+    
+    // Redirect to the app
+    http.Redirect(w, r, c.GetSiteURLHeader()+"/", http.StatusFound)
+}
+
+func getOIDCMetadata(c *Context, w http.ResponseWriter, r *http.Request) {
+    cfg := c.App.Config()
+    
+    metadata := map[string]string{
+        "discovery_endpoint": *cfg.OIDCSettings.DiscoveryEndpoint,
+        "button_text":        *cfg.OIDCSettings.ButtonText,
+        "button_color":       *cfg.OIDCSettings.ButtonColor,
+    }
+    
+    w.Header().Set("Content-Type", "application/json")
+    w.Write([]byte(model.MapToJSON(metadata)))
+}
\ No newline at end of file
